#!/usr/bin/env bash
# Launch or focus an already running TUI by binary name.
#
# Examples:
#   dot-launch-or-focus-tui btop [ARGS]

set -o errexit
set -o pipefail
set -o nounset

APP="${1}"

# Gets an app's last opened instance id, it's "null" if nothing is open.
APP_ID=$(
  niri msg --json windows |
    jq --arg app "${APP}" '
    [
      .[]
      | select(
          .app_id
          | ascii_downcase
          | endswith($app | ascii_downcase)
        )
    ]
    [-1]
    | .id
  '
)

if [ "${APP_ID}" == "null" ]; then
  if ! command -v "${APP}" >/dev/null 2>&1; then
    echo "${APP} does not exist, aborting!" >&2
    exit 1
  fi

  # We shift here so that $@ has all of the arguments but not the app name.
  shift

  niri msg action spawn -- ghostty --class="dot.ghostty.${APP}" -e "${APP}" "$@"
else
  niri msg action focus-window --id "${APP_ID}"
fi
