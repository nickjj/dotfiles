#!/usr/bin/env bash
# Set a few things to avoid leaking secrets and set reasonable font sizes.
#
# Examples:
#   rec-start -s  # scales display output (zoom in)
#   rec-start -o  # launches and positions OBS
#   rec-start -e  # exit after helping prevent secrets from being leaked

set -o errexit
set -o pipefail
set -o nounset

if [ -z "${NIRI_SOCKET}" ]; then
  echo "This script is only available with the desktop environment, sorry!" >&2
  exit 1
fi

SCALE=
OBS=
EXIT_EARLY=

GHOSTTY_FONT_SIZE=20

_usage() {
  cat <<EOF

Usage:
  ${0} [--obs | -o] [--scale | -s] [--exit-early | -e ]
EOF
}

while [[ "${#}" -gt 0 ]]; do
  case "${1}" in
  -h | --help | help)
    _usage
    exit
    ;;
  -s | --scale)
    SCALE=1
    GHOSTTY_FONT_SIZE=14
    shift
    ;;
  -o | --obs)
    OBS=1
    shift
    ;;
  -e | --exit-early)
    EXIT_EARLY=1
    shift
    ;;
  *)
    # Allow no arguments.
    [ -z "${1}" ] && break

    echo "Unknown argument: ${1}" >&2
    _usage >&2
    exit 1
    ;;
  esac
done

# Only create a backup if it doesn't exist. This avoids accidentally overwriting
# your real files if you create backups twice in a row.
if [ ! -f "${HISTFILE}.bak" ]; then
  cp -a "${HISTFILE}" "${HISTFILE}.bak"
  rm "${HISTFILE}"
fi

CLIPBOARD_HISTORY_FILE="${XDG_CACHE_HOME}/elephant/clipboard.gob"
if [ ! -f "${CLIPBOARD_HISTORY_FILE}" ]; then
  cp -a "${CLIPBOARD_HISTORY_FILE}" "${CLIPBOARD_HISTORY_FILE}.bak"
  rm "${CLIPBOARD_HISTORY_FILE}"
  dot-reload-app walker
fi

NEOVIM_SWAP_PATH="${XDG_STATE_HOME}/nvim/swap/%"
rm -f "${NEOVIM_SWAP_PATH}"*

# Avoid adjusting font sizes or anything else.
[ "${EXIT_EARLY}" == "1" ] && exit

perl -i -pe "s/^font-size = .*/font-size = ${GHOSTTY_FONT_SIZE}/g" "${DOTFILES_PATH}/.config/ghostty/config.local"
dot-reload-app ghostty

if [ "${SCALE}" == "1" ]; then
  perl -i -pe "s/^input { mouse { scroll-factor .*; }; }/input { mouse { scroll-factor 1.0; }; }/g" "${DOTFILES_PATH}/.config/niri/config.kdl.local"

  output-scale 3.0
fi

# It's handy for windows to open full screen since you're typically zoomed in
# or are capturing a region of your screen with a smaller resolution.
perl -i -pe "s/^window-rule { open-maximized .*; }/window-rule { open-maximized true; }/g" "${DOTFILES_PATH}/.config/niri/config.kdl.local"

# Launch and position OBS.
if [ "${OBS}" == "1" ]; then
  if ! pgrep obs >/dev/null 2>&1; then
    niri msg action spawn -- obs
  fi

  # OBS takes a little while to start, without this the ID is empty below.
  # I'm sure there's a better way to do this by looking at an event steam or
  # process list in a loop but this works for now.
  sleep 2

  OBS_ID=$(niri msg --json windows |
    jq --raw-output --exit-status '.[] | select(.app_id == "com.obsproject.Studio") | .id')

  niri msg action focus-window --id "${OBS_ID}"
  niri msg action move-window-to-monitor-right
fi

cat <<EOF
-> Shell history has been backed up to ${HISTFILE}.bak
-> Clipboard history has been backed up to ${CLIPBOARD_HISTORY_FILE}.bak
-> Temporary Neovim files have been deleted from ${NEOVIM_SWAP_PATH}

Apply Ghostty font-size adjustments
- CTRL + SHIFT + T to open a new tab (or open a new window)
- Close your original tabs (or windows)

Plan to switch between tmux sessions?
  - 1. Leader + CTRL + s to save your sessions
  - 2. tmux kill-server

Going to use a browser?
  - Close your current browser instances at your discretion
  - Open one with an isolated profile
    - Example: niri msg action spawn -- firefox -P "isolated"
      - Mod+Ctrl+Shift+Alt+B is mapped by default to do this

Various tips:
  - Use CTRL + L instead of running clear to clear your screen as needed
  - Make sure your windows are positioned correctly if recording a region
  - Be mindful of secrets in any .env file!
  - Make sure OBS is actually recording / streaming (if and when applicable)
EOF
