#!/usr/bin/env bash
# Set a theme by name, if omit then the next theme in the list will be set.
#
# Examples:
#   dot-theme-set --list
#   dot-theme-set NAME
#   dot-theme-set

set -o errexit
set -o pipefail
set -o nounset

# shellcheck disable=SC1091
. "${DOTFILES_PATH}/install"

mapfile -t ALL_THEMES < <(find "${DOTFILES_PATH}/themes" -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)

THEME="${1:-}"

if [ "${THEME}" = "--list" ]; then
  printf "%s\n" "${ALL_THEMES[@]}"
  exit
fi

if [ -z "${THEME}" ]; then
  ACTIVE_THEME_PATH="${XDG_CONFIG_HOME}/fzf/theme.sh"
  CURRENT_THEME=

  if [[ -L "${ACTIVE_THEME_PATH}" && -e "${ACTIVE_THEME_PATH}" ]]; then
    CURRENT_THEME=$(basename "$(dirname "$(readlink -f "${ACTIVE_THEME_PATH}")")")
  fi

  # Pick the first theme as a default.
  THEME="${ALL_THEMES[0]}"

  # Find the next theme, wrap back to the first one if at the end of the list.
  # Using ! ensures this returns an index (0, 1, etc.) instead of the name.
  for i in "${!ALL_THEMES[@]}"; do
    if [[ "${ALL_THEMES[${i}]}" = "${CURRENT_THEME}" ]]; then
      THEME="${ALL_THEMES[(i + 1) % ${#ALL_THEMES[@]}]}"
      break
    fi
  done
fi

set_theme "${THEME}"
